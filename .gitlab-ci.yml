variables:
  IMAGE_NAME: "${CI_REGISTRY_IMAGE}"
  NEWMAN_IMAGE_NAME: "${CI_REGISTRY_IMAGE}/newman"


stages:
  - build
  - analyse
  - ship
  - test

image: registry.gitlab.com/jakubigla/docker-compose-image

services:
  - docker:dind

before_script:
  - docker --version
  - docker-compose --version
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

build:
  stage: build
  script:
    - docker-compose run --rm -v "$(pwd)/.m2:/root/.m2" maven
  artifacts:
    paths:
      - target/*
  cache:
    paths:
      - .m2
  tags:
    - docker

sonar:
  stage: analyse
  dependencies:
    - build
  script:
    - docker-compose run --rm
        -v "$(pwd)/.sonar:/root/.sonar"
        -v "$(pwd)/.m2:/root/.m2"
      sonar-check
  cache:
    paths:
      - .m2
      - .sonar
  tags:
    - docker

dockerize:
  stage: ship
  dependencies:
    - build
  script:
    - docker-compose build api postman
    - docker-compose push api postman
  tags:
    - docker

integration:
  variables:
    POSTMAN_SLEEP: 10
  stage: test
  script:
    - docker-compose pull
    - docker-compose run --rm postman
  tags:
    - docker